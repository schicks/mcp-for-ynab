name: Attach Release Assets

on:
  release:
    types: [created]

permissions:
  contents: write  # Required to upload release assets

jobs:
  attach-assets:
    runs-on: ubuntu-latest

    steps:
      - name: Get release commit SHA
        id: release
        run: |
          # Get the actual commit SHA for this release tag
          # target_commitish can be a branch name like "main" or a commit SHA
          TAG="${{ github.event.release.tag_name }}"

          # Resolve the tag to its commit SHA
          COMMIT_SHA=$(gh api "/repos/${{ github.repository }}/git/ref/tags/$TAG" --jq '.object.sha')

          # If it's an annotated tag, we need to dereference it
          OBJECT_TYPE=$(gh api "/repos/${{ github.repository }}/git/tags/$COMMIT_SHA" --jq '.object.type' 2>/dev/null || echo "commit")

          if [ "$OBJECT_TYPE" = "commit" ]; then
            # It's an annotated tag, get the actual commit SHA
            COMMIT_SHA=$(gh api "/repos/${{ github.repository }}/git/tags/$COMMIT_SHA" --jq '.object.sha' 2>/dev/null || echo "$COMMIT_SHA")
          fi

          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"
          echo "Release commit: $COMMIT_SHA"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Find build workflow run
        id: find-run
        run: |
          # Find the workflow run for the build workflow at this commit
          echo "Searching for build workflow run at commit ${{ steps.release.outputs.COMMIT_SHA }}..."

          RUN_ID=$(gh api \
            "/repos/${{ github.repository }}/actions/workflows/build.yml/runs?head_sha=${{ steps.release.outputs.COMMIT_SHA }}&status=success" \
            --jq '.workflow_runs[0].id')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "Error: No successful build workflow run found for commit ${{ steps.release.outputs.COMMIT_SHA }}"
            echo "Make sure the build workflow has completed successfully for this commit."
            exit 1
          fi

          echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Found build workflow run: $RUN_ID"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download Linux artifact
        run: |
          echo "Downloading Linux artifact from run ${{ steps.find-run.outputs.RUN_ID }}..."
          gh run download ${{ steps.find-run.outputs.RUN_ID }} \
            --name mcp-ynab-linux \
            --repo ${{ github.repository }}

          # Verify download
          if [ ! -f "mcp-ynab-linux" ]; then
            echo "Error: Failed to download Linux artifact"
            exit 1
          fi

          ls -lh mcp-ynab-linux
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download Windows artifact
        run: |
          echo "Downloading Windows artifact from run ${{ steps.find-run.outputs.RUN_ID }}..."
          gh run download ${{ steps.find-run.outputs.RUN_ID }} \
            --name mcp-ynab-windows \
            --repo ${{ github.repository }}

          # Verify download
          if [ ! -f "mcp-ynab.exe" ]; then
            echo "Error: Failed to download Windows artifact"
            exit 1
          fi

          ls -lh mcp-ynab.exe
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Upload assets to release
        run: |
          echo "Uploading assets to release ${{ github.event.release.tag_name }}..."

          gh release upload ${{ github.event.release.tag_name }} \
            mcp-ynab-linux \
            mcp-ynab.exe \
            --repo ${{ github.repository }} \
            --clobber

          echo "✓ Assets uploaded successfully"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Release summary
        run: |
          echo "## Release Assets Attached ✓" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release**: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ steps.release.outputs.COMMIT_SHA }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Assets Uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- \`mcp-ynab-linux\` - Linux x64 executable" >> $GITHUB_STEP_SUMMARY
          echo "- \`mcp-ynab.exe\` - Windows x64 executable" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View release: ${{ github.event.release.html_url }}" >> $GITHUB_STEP_SUMMARY
